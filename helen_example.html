

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deep Alignement Network with delira &mdash; Deep Alignment Network PyTorch 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to delira-compatible cycle-GAN’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Deep Alignment Network PyTorch
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/justusschock/deep_alignment_network_pytorch">GitHub</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Deep Alignment Network PyTorch</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Deep Alignement Network with delira</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/helen_example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deep-alignement-network-with-delira">
<h1>Deep Alignement Network with <a class="reference external" href="https://github.com/justusschock/delira">delira</a><a class="headerlink" href="#deep-alignement-network-with-delira" title="Permalink to this headline">¶</a></h1>
<p>The following example shows the basic usage of the provided DAN
implementation with <code class="docutils literal notranslate"><span class="pre">delira</span></code></p>
<p>First we need to download our data. For training, we use the HELEN
Dataset, which can be downloaded
<a class="reference external" href="https://ibug.doc.ic.ac.uk/download/annotations/helen.zip">here</a>.</p>
<blockquote>
<div><strong>Note</strong>: Since this dataset contains only a small amount of data,
you may want to download the other datasets on this website as well
and add them to your trainset.</div></blockquote>
<p>To automate the necessary preprocessing, please insert the path to the
downloaded zip-file below:</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zip_path</span> <span class="o">=</span> <span class="s2">&quot;/PATH/TO/YOUR/ZIPFILE&quot;</span>
</pre></div>
</div>
<p>First we need to preprocess our dataset, which is simply extracting it
and calculating the mean face. TO extract it, we use the libraries
<code class="docutils literal notranslate"><span class="pre">zipfile</span></code> and <code class="docutils literal notranslate"><span class="pre">os</span></code>:</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="c1"># create directory &quot;dataset&quot; in same directory as zip file</span>
<span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>

<span class="c1"># if there is not an dataset already</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
            <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span>

<span class="n">train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;trainset&quot;</span><span class="p">)</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;testset&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we need to calculate the trainset’s mean shape. For this, we use
<code class="docutils literal notranslate"><span class="pre">numpy</span></code> and <code class="docutils literal notranslate"><span class="pre">shapedata</span></code>:</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">shapedata</span>

<span class="c1"># if mean shape has not been computed yet:</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;mean_shape.npz&quot;</span><span class="p">)):</span>

    <span class="c1"># Loading whole traindata</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">shapedata</span><span class="o">.</span><span class="n">SingleShapeDataProcessing</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">train_path</span><span class="p">)</span>

    <span class="c1"># store landmarks as numpy array and calculate mean</span>
    <span class="n">landmarks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">landmarks</span><span class="p">)</span>
    <span class="n">mean_shape</span> <span class="o">=</span> <span class="n">landmarks</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># save mean_shape to disk</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;mean_shape.npz&quot;</span><span class="p">),</span> <span class="n">mean_shape</span><span class="o">=</span><span class="n">mean_shape</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">mean_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="s2">&quot;mean_shape.npz&quot;</span><span class="p">))[</span><span class="s2">&quot;mean_shape&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>You just have to do these steps once, now you can simply load the
mean_shape with
<code class="docutils literal notranslate"><span class="pre">np.load(os.path.join(image_dir,</span> <span class="pre">&quot;mean_shape.npz&quot;))[&quot;mean_shape&quot;]</span></code></p>
<p>Now we will create our datasets (with classes from <code class="docutils literal notranslate"><span class="pre">shapedata</span></code> and
<code class="docutils literal notranslate"><span class="pre">delira</span></code>):</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">delira.data_loading</span> <span class="k">import</span> <span class="n">BaseDataManager</span>
<span class="kn">from</span> <span class="nn">delira.data_loading.sampler</span> <span class="k">import</span> <span class="n">RandomSampler</span><span class="p">,</span> <span class="n">SequentialSampler</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># some augmentations for train data:</span>
<span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">CROP</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">EXTENSION</span> <span class="o">=</span> <span class="s2">&quot;.pts&quot;</span>
<span class="n">ROTATE</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">RANDOM_OFFSET</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">RANDOM_SCALE</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># create trainset with augmentations</span>
<span class="n">dset_train</span> <span class="o">=</span> <span class="n">shapedata</span><span class="o">.</span><span class="n">SingleShapeDataset</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span>
                                         <span class="n">img_size</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">,</span>
                                         <span class="n">crop</span><span class="o">=</span><span class="n">CROP</span><span class="p">,</span>
                                         <span class="n">extension</span><span class="o">=</span><span class="n">EXTENSION</span><span class="p">,</span>
                                         <span class="n">rotate</span><span class="o">=</span><span class="n">ROTATE</span><span class="p">,</span>
                                         <span class="n">random_offset</span><span class="o">=</span><span class="n">RANDOM_OFFSET</span><span class="p">,</span>
                                         <span class="n">random_scale</span><span class="o">=</span><span class="n">RANDOM_SCALE</span>
                                         <span class="p">)</span>

<span class="c1"># create testset without augmentations</span>
<span class="n">dset_test</span> <span class="o">=</span> <span class="n">shapedata</span><span class="o">.</span><span class="n">SingleShapeDataset</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span>
                                         <span class="n">img_size</span><span class="o">=</span><span class="n">IMG_SIZE</span><span class="p">,</span>
                                         <span class="n">crop</span><span class="o">=</span><span class="n">CROP</span><span class="p">,</span>
                                         <span class="n">extension</span><span class="o">=</span><span class="n">EXTENSION</span><span class="p">,</span>
                                         <span class="n">rotate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">random_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">random_scale</span><span class="o">=</span><span class="kc">False</span>
                                         <span class="p">)</span>

<span class="c1"># create data managers out of datasets</span>
<span class="n">man_train</span> <span class="o">=</span> <span class="n">BaseDataManager</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                            <span class="n">n_process_augmentation</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">sampler_cls</span><span class="o">=</span><span class="n">RandomSampler</span><span class="p">)</span>
<span class="n">man_test</span> <span class="o">=</span> <span class="n">BaseDataManager</span><span class="p">(</span><span class="n">dset_test</span><span class="p">,</span>
                           <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
                           <span class="n">n_process_augmentation</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                           <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">sampler_cls</span><span class="o">=</span><span class="n">SequentialSampler</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, that we have defined our datasets for images of size 224x224
pixels, we need to take care of our model definition. Now we need to
define our training and model arguments using the <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> class
from <code class="docutils literal notranslate"><span class="pre">delira</span></code> and some functions and classes given in this package
(here we import it for the first time):</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dan</span>

<span class="kn">from</span> <span class="nn">delira.training</span> <span class="k">import</span> <span class="n">Parameters</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">callback_stages</span> <span class="o">=</span> <span class="n">dan</span><span class="o">.</span><span class="n">AddDanStagesCallback</span><span class="p">(</span><span class="n">epoch_freq</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span>
    <span class="n">fixed_params</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;training&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;num_epochs&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;criterions&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s2">&quot;optimizer_cls&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span>
            <span class="s2">&quot;optimizer_params&quot;</span><span class="p">:{</span>
                <span class="s2">&quot;max_stages&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;MSE&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()},</span>
            <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">callback_stages</span><span class="p">],</span>
            <span class="s2">&quot;lr_sched_cls&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;lr_sched_params&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">},</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s2">&quot;mean_shape&quot;</span><span class="p">:</span> <span class="n">mean_shape</span><span class="p">,</span>
            <span class="s2">&quot;num_stages&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;return_intermediate_lmks&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Finally! Now, we can start our training using the <code class="docutils literal notranslate"><span class="pre">PyTorchExperiment</span></code>.</p>
<p>We just do a few minor specifications here:</p>
<ul class="simple">
<li>set the usable GPUs to the first available GPU if any GPUs have been
detected (else specify the usable GPUs to be empty, which causes a
training on CPU)</li>
<li>use the <code class="docutils literal notranslate"><span class="pre">create_optimizers_dan_per_stage</span></code> to automatically create
optimizers for our DeepAlinmentNetwork (you could also use
<code class="docutils literal notranslate"><span class="pre">create_optimizers_dan_whole_network</span></code> to create a single optimizer
holding all network parameters)</li>
<li>use the <code class="docutils literal notranslate"><span class="pre">DeepAlignmentNetwork</span></code> class as our network, which defines
the training and prediction behavior.</li>
</ul>
<p>Now let’s start training!</p>
<div class="code ipython3 highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">delira.training</span> <span class="k">import</span> <span class="n">PyTorchExperiment</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">gpu_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gpu_ids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">PyTorchExperiment</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                        <span class="n">dan</span><span class="o">.</span><span class="n">DeepAlignmentNetwork</span><span class="p">,</span>
                        <span class="n">optim_builder</span><span class="o">=</span><span class="n">dan</span><span class="o">.</span><span class="n">create_optimizers_dan_per_stage</span><span class="p">,</span>
                        <span class="n">gpu_ids</span><span class="o">=</span><span class="n">gpu_ids</span><span class="p">,</span>
                        <span class="n">val_score_key</span><span class="o">=</span><span class="s2">&quot;val_MSE_final_stage&quot;</span><span class="p">)</span>
<span class="n">exp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">man_train</span><span class="p">,</span> <span class="n">man_test</span><span class="p">)</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to delira-compatible cycle-GAN’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Justus Schock

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>